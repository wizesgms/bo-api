<!DOCTYPE html>
<html lang="ko" id="themeMode" class="light">
    <!-- header -->
    <%- include('../shared/header.ejs', {title: __('dashboard.page_title') }) -%>

    <body class="app">
        <!-- preloader -->
        <%- include('../shared/preloader.ejs') -%>

        <!-- mobile menu -->
        <%- include('../shared/mobile.ejs') -%>

        <div class="flex">
            <!-- sidebar -->
            <%- include('../shared/sidebar.ejs') -%>

            <div class="content">
                <!-- topbar -->
                <%- include('../shared/topbar.ejs') -%>

                <!-- main content here -->
                <div class="grid grid-cols-12 gap-6">
                    <div class="col-span-12 xxl:col-span-12 grid grid-cols-12 gap-6">
                        <div class="col-span-12 mt-8">
                            <div class="col-span-12 mt-2">
                                <div class="intro-y flex items-center h-10">
                                    <h2 class="text-lg font-medium truncate mr-5"><%= __('dashboard.title') %></h2>

                                    <a href="" class="ml-auto flex text-theme-1 dark:text-theme-10">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="24"
                                            height="24"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="1.5"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="feather feather-refresh-ccw w-4 h-4 mr-3"
                                        >
                                            <polyline points="1 4 1 10 7 10"></polyline>
                                            <polyline points="23 20 23 14 17 14"></polyline>
                                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                                        </svg>
                                        <%= __('common.reload') %>
                                    </a>
                                </div>

                                <% for (var i = 0; i < popups.length; i ++) { %>
                                <div class="rounded-md items-center px-5 py-4 mb-2 bg-theme-1 text-white">
                                    <div class="flex items-center" style="font-size: 15px">
                                        <i data-feather="alert-circle" class="w-6 h-6 mr-2"></i> <%= __('dashboard.popup.new') %> : &nbsp;
                                        <div><%= popups[i].content %>.</div>
                                    </div>
                                    <div class="text-white mt-2"><%= __('dashboard.popup.create_date') %> : ( <%= popups[i].createdAt %> )</div>
                                </div>
                                <% } %>

                                <div class="grid grid-cols-12 gap-6 mt-2">
                                    <div class="col-span-12 sm:col-span-6 xl:col-span-3 intro-y">
                                        <div class="report-box zoom-in">
                                            <div class="box p-5">
                                                <div class="flex justify-between">
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        width="24"
                                                        height="24"
                                                        viewBox="0 0 24 24"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        stroke-width="1.5"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        class="feather feather-layers report-box__icon text-theme-10"
                                                    >
                                                        <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                                                        <polyline points="2 17 12 22 22 17"></polyline>
                                                        <polyline points="2 12 12 17 22 12"></polyline>
                                                    </svg>
                                                    <div class="text-3xl font-bold leading-8"><%= details.childAgentCount %></div>
                                                </div>
                                                <div class="text-base text-gray-600 mt-2"><%= __('dashboard.count.hub.agentName') %></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-span-12 sm:col-span-6 xl:col-span-3 intro-y">
                                        <div class="report-box zoom-in">
                                            <div class="box p-5">
                                                <div class="flex justify-between">
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        width="24"
                                                        height="24"
                                                        viewBox="0 0 24 24"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        stroke-width="1.5"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        class="feather feather-monitor report-box__icon text-theme-11"
                                                    >
                                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                                        <line x1="8" y1="21" x2="16" y2="21"></line>
                                                        <line x1="12" y1="17" x2="12" y2="21"></line>
                                                    </svg>
                                                    <div class="text-3xl font-bold leading-8"><%= details.childUserCount %></div>
                                                </div>
                                                <div class="text-base text-gray-600 mt-2"><%= __('dashboard.count.hub.userName') %></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-span-12 sm:col-span-6 xl:col-span-3 intro-y">
                                        <div class="report-box zoom-in">
                                            <div class="box p-5">
                                                <div class="flex justify-between">
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        width="24"
                                                        height="24"
                                                        viewBox="0 0 24 24"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        stroke-width="1.5"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        class="feather feather-target report-box__icon text-theme-12"
                                                    >
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <circle cx="12" cy="12" r="6"></circle>
                                                        <circle cx="12" cy="12" r="2"></circle>
                                                    </svg>
                                                    <div class="text-3xl font-bold leading-8"><%= details.userCount %></div>
                                                </div>
                                                <div class="text-base text-gray-600 mt-2"><%= __('dashboard.count.own.usersName') %></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-span-12 sm:col-span-6 xl:col-span-3 intro-y">
                                        <div class="report-box zoom-in">
                                            <div class="box p-5">
                                                <div class="flex justify-between">
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        width="24"
                                                        height="24"
                                                        viewBox="0 0 24 24"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        stroke-width="1.5"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        class="feather feather-globe report-box__icon text-theme-9"
                                                    >
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <line x1="2" y1="12" x2="22" y2="12"></line>
                                                        <path
                                                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
                                                        ></path>
                                                    </svg>
                                                    <div class="text-3xl font-bold leading-8"><%= details.playerCount %></div>
                                                </div>
                                                <div class="text-base text-gray-600 mt-2"><%= __('dashboard.count.connected.usersName') %></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-12 lg:col-span-6 intro-y gap-1">
                        <div class="intro-y box p-5">
                            <div class="flex xl:flex-row xl:items-center">
                                <div class="flex mr-auto">
                                    <div>
                                        <div class="text-gray-600 dark:text-gray-600"><%= __('dashboard.graph.my_money') %></div>
                                    </div>
                                </div>
                                <div class="flex ml-auto mt-0">
                                    <div>
                                        <div id="agentMoneySum" class="text-theme-20 dark:text-gray-300 text-sm font-bold"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="report-chart">
                                <canvas
                                    id="graph-agent-money"
                                    height="300"
                                    class="mt-2 chartjs-render-monitor"
                                    style="display: block; width: 661px; height: 352px"
                                    width="661"
                                >
                                </canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-12 lg:col-span-6 intro-y gap-1">
                        <div class="intro-y box p-5">
                            <div class="flex xl:flex-row xl:items-center">
                                <div class="flex mr-auto">
                                    <div>
                                        <div class="text-gray-600 dark:text-gray-600"><%= __('dashboard.graph.own_user_money') %></div>
                                    </div>
                                </div>
                                <div class="flex ml-auto mt-0">
                                    <div>
                                        <div id="ownUserMoneySum" class="text-theme-20 dark:text-gray-300 text-sm font-bold"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="report-chart">
                                <canvas
                                    id="graph-own-user-money"
                                    height="300"
                                    class="mt-2 chartjs-render-monitor"
                                    style="display: block; width: 661px; height: 352px"
                                    width="661"
                                >
                                </canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-12 lg:col-span-6 intro-y gap-1">
                        <div class="intro-y box p-5">
                            <div class="flex xl:flex-row xl:items-center">
                                <div class="flex mr-auto">
                                    <div>
                                        <div class="text-gray-600 dark:text-gray-600"><%= __('dashboard.graph.hub_agent_money') %></div>
                                    </div>
                                </div>
                                <div class="flex ml-auto mt-0">
                                    <div>
                                        <div id="hubAgentMoneySum" class="text-theme-20 dark:text-gray-300 text-sm font-bold"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="report-chart">
                                <canvas
                                    id="graph-hub-agent-money"
                                    height="300"
                                    class="mt-2 chartjs-render-monitor"
                                    style="display: block; width: 661px; height: 352px"
                                    width="661"
                                >
                                </canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-12 lg:col-span-6 intro-y gap-1">
                        <div class="intro-y box p-5">
                            <div class="flex xl:flex-row xl:items-center">
                                <div class="flex mr-auto">
                                    <div>
                                        <div class="text-gray-600 dark:text-gray-600"><%= __('dashboard.graph.hub_user_money') %></div>
                                    </div>
                                </div>
                                <div class="flex ml-auto mt-0">
                                    <div>
                                        <div id="hubUserMoneySum" class="text-theme-20 dark:text-gray-300 text-sm font-bold"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="report-chart">
                                <canvas
                                    id="graph-hub-user-money"
                                    height="300"
                                    class="mt-2 chartjs-render-monitor"
                                    style="display: block; width: 661px; height: 352px"
                                    width="661"
                                >
                                </canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- footer -->
        <%- include('../shared/footer.ejs') -%>

        <!-- global -->
        <%- include('../shared/global.ejs') -%>

        <script>
            $("#menu-1").addClass("side-menu--active");
            $("#menu-1 + ul").addClass("side-menu__sub-open");

            const popups = `<%= popups %>`;
            const balanceHistories = JSON.parse(`<%- JSON.stringify(details.balanceHistories) %>`);
            let balances = JSON.parse(`<%- JSON.stringify(balances) %>`);

            $("#agentMoneySum").html(convertNumber(balances.agentBalance, "<%= session.locale %>"));
            $("#ownUserMoneySum").html(convertNumber(balances.ownUserBalances, "<%= session.locale %>"));
            $("#hubAgentMoneySum").html(convertNumber(balances.hubAgentBalances, "<%= session.locale %>"));
            $("#hubUserMoneySum").html(convertNumber(balances.hubUserBalances, "<%= session.locale %>"));

            // 기정 채트 옵션.
            const chartOption = {
                type: "line",
                options: {
                    legend: {
                        display: false,
                    },
                    scales: {
                        xAxes: [
                            {
                                ticks: {
                                    fontSize: "10",
                                    fontColor: cash("html").hasClass("dark") ? "#718096" : "#777777",
                                },
                                gridLines: {
                                    display: false,
                                },
                            },
                        ],
                        yAxes: [
                            {
                                ticks: {
                                    display: false,
                                },
                                gridLines: {
                                    color: cash("html").hasClass("dark") ? "#718096" : "#D8D8D8",
                                    zeroLineColor: cash("html").hasClass("dark") ? "#718096" : "#D8D8D8",
                                    borderDash: [2, 4],
                                    drawBorder: false,
                                },
                            },
                        ],
                    },
                },
            };

            // 정적 그래프 데이터 옵션.
            const getDataOption = (obj) => {
                return {
                    data: {
                        labels: obj.date,
                        datasets: [
                            {
                                label: "<%= __('dashboard.chart.money.info') %>",
                                data: obj.data,
                                borderWidth: 2,
                                borderColor: "#3160D8",
                                backgroundColor: "transparent",
                                pointBorderColor: "#c9c4c4",
                            },
                        ],
                    },
                };
            };

            function drawStaticHistoryGraph(ctx, obj) {
                new Chart(ctx, { ...chartOption, ...getDataOption(obj) });
            }

            function funcStaticDrawGraph() {
                const showLimit = 15;
                const historyData = {};
                const historyType = ["createdAt", "agentBalance", "userBalanceSum", "childAgentBalanceSum", "childUserBalanceSum"];
                let histories = {};

                for (let i = 0; i < showLimit && i < balanceHistories.length; i++) {
                    const historyObj = balanceHistories[i];
                    const createdAt = moment(historyObj.createdAt).format("HH");

                    for (let index = 0; index < historyType.length; index++) {
                        const key = historyType[index];

                        if (!Object.hasOwnProperty.call(historyData, key)) {
                            historyData[key] = [];
                        }

                        if (key != "createdAt") {
                            historyData[key].push(historyObj[key]);
                        }
                    }

                    historyData["createdAt"].push(createdAt);
                }

                histories = {
                    agent: { data: historyData.agentBalance, date: historyData.createdAt, target: "graph-agent-money" },
                    ownUser: { data: historyData.userBalanceSum, date: historyData.createdAt, target: "graph-own-user-money" },
                    childAgent: { data: historyData.childAgentBalanceSum, date: historyData.createdAt, target: "graph-hub-agent-money" },
                    childUser: { data: historyData.childUserBalanceSum, date: historyData.createdAt, target: "graph-hub-user-money" },
                };

                Object.keys(histories).map((history) => {
                    const ctx = document.getElementById(histories[history].target);
                    drawStaticHistoryGraph(ctx, histories[history]);
                });
            }

            // init
            funcStaticDrawGraph();
        </script>
    </body>
</html>
